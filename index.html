
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#3f6158" />
  <title>All바른 English</title>
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="All바른 English" />
  <link rel="manifest" href="manifest.json" />
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f2;
      font-size: 18px;
    }
    header {
      background: #3f6158;
      color: white;
      padding: 1em;
      text-align: center;
      font-size: 1.8em;
      font-weight: bold;
    }
    nav {
      display: flex;
      flex-wrap: nowrap;
      background: #dcedc8;
      justify-content: space-around;
      padding: 0;
      border-bottom: 2px solid #a0c79b;
    }
    nav button {
      flex: 1;
      background: none;
      border: none;
      font-size: 1.2em;
      font-weight: bold;
      color: #3f6158;
      cursor: pointer;
      padding: 1em 0.5em;
      border-bottom: 4px solid transparent;
      transition: all 0.3s;
    }
    nav button.active {
      border-bottom: 4px solid #3f6158;
      background: #e6f4dc;
    }
    section {
      padding: 1.5em;
      display: none;
    }
    section.active {
      display: block;
    }
    .section-title {
      font-size: 1.4em;
      margin-bottom: 0.7em;
      color: #3f6158;
      font-weight: bold;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin: 1em 0;
      padding: 1.2em;
      white-space: pre-wrap;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.8em;
      text-align: center;
    }
    select, input[type="date"] {
      padding: 0.7em;
      margin: 0.8em 0;
      font-size: 1.1em;
      width: 100%;
      display: block;
    }
    #loader {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 60vh;
      transition: opacity 0.3s ease;
    }
    #loader.hidden { display: none; }
    .loader-text {
      margin-top: 1em;
      color: #3f6158;
      font-weight: bold;
      font-size: 1.2em;
    }
    .mode-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 0.5em 1em;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      z-index: 100;
    }
    body.dark {
      background: #1a1a1a;
      color: #e0e0e0;
    }
    body.dark header, body.dark nav {
      background: #333;
      color: white;
    }
    body.dark .card, body.dark table {
      background: #2a2a2a;
      color: #f0f0f0;
    }
    @media (max-width: 600px) {
      html, body { font-size: 17px; }
      nav button { font-size: 1.1em; padding: 0.8em 0.4em; }
      .section-title { font-size: 1.2em; }
    }
  </style>
</head>
<body>
  <button class="mode-toggle" onclick="toggleMode()">🌗 모드 전환</button>
  <header>All바른 English</header>
  <nav>
    <button onclick="showTab('notice')" class="active">공지사항</button>
    <button onclick="showTab('exam')">시험정보</button>
    <button onclick="showTab('retest')">재시험</button>
  </nav>

  <section id="notice" class="active">
    <div class="section-title">📌 공지사항</div>
    <div id="notice-content"></div>
  </section>

  <section id="exam">
    <div class="section-title">📝 시험정보</div>
    <input type="date" id="exam-date">
    <select id="class-select"></select>
    <div id="exam-table"></div>
  </section>

  <section id="retest">
    <div class="section-title">🔁 재시험 명단</div>
    <div id="retest-table"></div>
  </section>

  <div id="loader">
    <svg width="50" height="50" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
      <circle cx="50" cy="50" r="35" stroke-width="10" stroke="#3f6158"
        stroke-dasharray="164.93361431346415 56.97787143782138" fill="none"
        stroke-linecap="round">
        <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite"
          dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"/>
      </circle>
    </svg>
    <div class="loader-text">로딩중...</div>
  </div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzyk-n_G93BJG1vlck6DNakEdZolCSoB9I3ylmyN2e6qX9NNHdQYgx6phA4OU9JAwfT/exec";

    function showTab(tabId) {
      document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.querySelector("nav button[onclick*='" + tabId + "']").classList.add("active");
      document.getElementById(tabId).classList.add("active");
    }

    function toggleMode() {
      document.body.classList.toggle("dark");
    }

    function cleanDate(isoDate) {
      if (!isoDate) return "";
      const d = new Date(isoDate);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    async function fetchSheet(sheetName) {
      const res = await fetch(SHEET_URL + "?sheetName=" + sheetName);
      return await res.json();
    }

    async function loadNotice() {
      const data = await fetchSheet("Notice");
      const target = document.getElementById("notice-content");
      target.innerHTML = "";
      for (let i = 1; i < data.length; i++) {
        const [date, title, content] = data[i];
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `📅 ${cleanDate(date)}
<b>${title}</b>
${content}`;
        target.appendChild(card);
      }
    }

    async function loadClassDropdown() {
      const data = await fetchSheet("TestInfo");
      const select = document.getElementById("class-select");
      const uniqueClasses = [...new Set(data.slice(1).map(row => row[0]))];
      select.innerHTML = uniqueClasses.map(c => `<option>${c}</option>`).join("");
    }

    async function loadExam() {
      const data = await fetchSheet("TestInfo");
      const date = document.getElementById("exam-date").value;
      const className = document.getElementById("class-select").value;
      const table = document.getElementById("exam-table");
      const filtered = data.filter((row, i) => i === 0 || (row[0] === className && cleanDate(row[1]) === date));

      let html = "<table><tr>" + data[0].slice(0, 3).map(h => `<th>${h}</th>`).join("") + "</tr>";
      for (let i = 1; i < filtered.length; i++) {
        html += "<tr>" + filtered[i].slice(0, 3).map((cell, j) => `<td>${j === 1 ? cleanDate(cell) : cell}</td>`).join("") + "</tr>";
      }
      html += "</table>";
      table.innerHTML = html;
    }

    async function loadRetest() {
      const data = await fetchSheet("Retest");
      const target = document.getElementById("retest-table");
      let html = "<table><tr>" + data[0].map(h => `<th>${h}</th>`).filter(h => !h.includes("재시험")).join("") + "</tr>";
      for (let i = 1; i < data.length; i++) {
        html += "<tr>" + data[i].map((cell, j) => j === 3 ? null : `<td>${j === 2 ? cleanDate(cell) : cell}</td>`).filter(c => c).join("") + "</tr>";
      }
      html += "</table>";
      target.innerHTML = html;
    }

    window.onload = async () => {
      await Promise.all([
        loadNotice(),
        loadClassDropdown(),
        loadRetest()
      ]);
      setTimeout(() => {
        document.getElementById("loader").classList.add("hidden");
      }, 500); // fallback: 0.5초 뒤 로딩 숨기기
      document.getElementById("exam-date").addEventListener("change", loadExam);
      document.getElementById("class-select").addEventListener("change", loadExam);
    };
  </script>
</body>
</html>
